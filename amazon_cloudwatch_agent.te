policy_module(amazon_cloudwatch_agent, 1.0.3)

require {
    type amazon_cloudwatch_agent_t;
    type amazon_cloudwatch_agent_exec_t;
    type var_log_t;
    type proc_t;
    type sysfs_t;
    type cgroup_t;
    type passwd_file_t;
    type devpts_t;
    type tmp_t;
    type systemd_systemctl_exec_t;
    type fusefs_t;
    type configfs_t;
    type nfsd_fs_t;
    type efivarfs_t;
    type bpf_t;
    type mqueue_t;
    type pstorefs_t;
    type debugfs_t;
    type tracefs_t;
    type tmpfs_t;
    type boot_t;
    type hugetlbfs_t;

    class file { getattr open read write append create unlink execute execute_no_trans setattr };
    class dir { getattr open read write search add_name remove_name setattr };
    class fifo_file { getattr open read write };
    class filesystem getattr;
    class unix_stream_socket { create connectto };
    class netlink_route_socket { create bind read write nlmsg_read nlmsg_write getattr };
    class udp_socket { create connect getattr setopt read write };
    class tcp_socket { create name_bind };
    class capability { net_admin chown fowner dac_override };
    class process { fork setpgid signal_perms noatsecure rlimitinh };
    class system module_request;
}

# Define domain
type amazon_cloudwatch_agent_t;
type amazon_cloudwatch_agent_exec_t;
init_daemon_domain(amazon_cloudwatch_agent_t, amazon_cloudwatch_agent_exec_t)

# Allow full self permissions
allow amazon_cloudwatch_agent_t self:process { fork setpgid signal_perms noatsecure rlimitinh };
allow amazon_cloudwatch_agent_t self:fifo_file { getattr open read write };
allow amazon_cloudwatch_agent_t self:unix_stream_socket { create connectto };
allow amazon_cloudwatch_agent_t self:tcp_socket { create name_bind };
allow amazon_cloudwatch_agent_t self:udp_socket { create connect getattr setopt read write };
allow amazon_cloudwatch_agent_t self:netlink_route_socket { create bind write read nlmsg_read nlmsg_write getattr };
allow amazon_cloudwatch_agent_t self:capability { net_admin chown fowner dac_override };

# File permissions
files_read_etc_files(amazon_cloudwatch_agent_t)
files_read_usr_files(amazon_cloudwatch_agent_t)
files_read_var_files(amazon_cloudwatch_agent_t)

# Logging permissions
logging_send_syslog_msg(amazon_cloudwatch_agent_t)
logging_read_generic_logs(amazon_cloudwatch_agent_t)

# Network permissions
corenet_tcp_bind_generic_node(amazon_cloudwatch_agent_t)
corenet_udp_bind_generic_node(amazon_cloudwatch_agent_t)
corenet_tcp_connect_all_ports(amazon_cloudwatch_agent_t)
sysnet_dns_name_resolve(amazon_cloudwatch_agent_t)

# Execute permissions
corecmd_exec_bin(amazon_cloudwatch_agent_t)
corecmd_exec_shell(amazon_cloudwatch_agent_t)

# System information access
kernel_read_system_state(amazon_cloudwatch_agent_t)
kernel_read_network_state(amazon_cloudwatch_agent_t)

# Device access
dev_read_sysfs(amazon_cloudwatch_agent_t)
dev_read_urand(amazon_cloudwatch_agent_t)

# Specific type permissions
allow amazon_cloudwatch_agent_t var_log_t:dir { getattr search open read write add_name remove_name setattr };
allow amazon_cloudwatch_agent_t var_log_t:file { getattr open read write create unlink setattr };
allow amazon_cloudwatch_agent_t proc_t:dir { getattr search open read };
allow amazon_cloudwatch_agent_t proc_t:file { getattr open read };
allow amazon_cloudwatch_agent_t sysfs_t:dir { getattr search open read };
allow amazon_cloudwatch_agent_t sysfs_t:file { getattr open read };
allow amazon_cloudwatch_agent_t cgroup_t:dir { getattr search open read };
allow amazon_cloudwatch_agent_t passwd_file_t:file { getattr open read };

# Allow CloudWatch Agent to read various filesystems/dirs/files
allow amazon_cloudwatch_agent_t { devpts_t hugetlbfs_t tmp_t systemd_systemctl_exec_t fusefs_t configfs_t nfsd_fs_t efivarfs_t bpf_t mqueue_t pstorefs_t debugfs_t tracefs_t tmpfs_t boot_t }:dir { getattr search open read };
allow amazon_cloudwatch_agent_t { devpts_t hugetlbfs_t tmp_t systemd_systemctl_exec_t fusefs_t configfs_t nfsd_fs_t efivarfs_t bpf_t mqueue_t pstorefs_t debugfs_t tracefs_t tmpfs_t boot_t }:file { getattr open read };
allow amazon_cloudwatch_agent_t { devpts_t hugetlbfs_t tmp_t systemd_systemctl_exec_t fusefs_t configfs_t nfsd_fs_t efivarfs_t bpf_t mqueue_t pstorefs_t debugfs_t tracefs_t tmpfs_t boot_t }:filesystem getattr;
