policy_module(amazon_cloudwatch_agent, 1.0.2)

require {
    type unconfined_t;
    type bin_t;
    type var_run_t;
    type proc_t;
    type sysfs_t;
    type var_log_t;
    type fixed_disk_device_t;
    type http_port_t;
    type node_t;
    type unreserved_port_t;
    attribute file_type;
    class file { getattr open read write append create unlink };
    class dir { search read write add_name remove_name };
    class lnk_file { read getattr };
    class sock_file { write };
    class tcp_socket { create connect bind name_connect };
    class udp_socket { create connect bind };
    class netlink_route_socket { create bind getattr write read nlmsg_read };
    class process { fork setpgid };
    class capability { net_admin chown dac_override setgid setuid };
}

type amazon_cloudwatch_agent_t;
type amazon_cloudwatch_agent_exec_t;
init_daemon_domain(amazon_cloudwatch_agent_t, amazon_cloudwatch_agent_exec_t)

# Allow the agent to access its own resources
allow amazon_cloudwatch_agent_t self:process { fork setpgid };
allow amazon_cloudwatch_agent_t self:fifo_file rw_fifo_file_perms;
allow amazon_cloudwatch_agent_t self:unix_stream_socket create_stream_socket_perms;

# Network permissions
allow amazon_cloudwatch_agent_t self:tcp_socket create_stream_socket_perms;
allow amazon_cloudwatch_agent_t self:udp_socket create_socket_perms;
allow amazon_cloudwatch_agent_t http_port_t:tcp_socket name_connect;
allow amazon_cloudwatch_agent_t unreserved_port_t:tcp_socket { name_bind name_connect };
allow amazon_cloudwatch_agent_t unreserved_port_t:udp_socket name_bind;
allow amazon_cloudwatch_agent_t node_t:tcp_socket node_bind;
allow amazon_cloudwatch_agent_t node_t:udp_socket node_bind;

# File permissions
allow amazon_cloudwatch_agent_t file_type:dir { read getattr open search };
allow amazon_cloudwatch_agent_t file_type:file { read getattr open };
allow amazon_cloudwatch_agent_t file_type:lnk_file { read getattr };

# Specific permissions
allow amazon_cloudwatch_agent_t var_log_t:dir { add_name write remove_name };
allow amazon_cloudwatch_agent_t var_log_t:file { append open setattr create write unlink };
allow amazon_cloudwatch_agent_t proc_t:file { read getattr open };
allow amazon_cloudwatch_agent_t sysfs_t:file { read getattr open };
allow amazon_cloudwatch_agent_t fixed_disk_device_t:blk_file { getattr open read };

# Network related
allow amazon_cloudwatch_agent_t self:netlink_route_socket { create bind write read nlmsg_read nlmsg_write getattr };

# Capabilities
allow amazon_cloudwatch_agent_t self:capability { net_admin chown dac_override setgid setuid };

# Allow DNS resolution
sysnet_dns_name_resolve(amazon_cloudwatch_agent_t)

# Logging
logging_send_syslog_msg(amazon_cloudwatch_agent_t)